<!DOCTYPE html>
<html>
<head>
    <title>Dashboard de An√°lise de Incidentes - Interativo</title>
    <meta charset="utf-8">
    <!-- Self-contained SVG charts for GitHub Pages compatibility -->
    <style>
        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chart-svg {
            width: 100%;
            height: 100%;
        }
        
        .chart-bar {
            transition: fill 0.2s ease;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
        }
        
        .chart-text {
            font-family: Arial, sans-serif;
            font-size: 12px;
            fill: #495057;
        }
        
        .chart-title-text {
            font-size: 14px;
            font-weight: bold;
            fill: #495057;
        }
        
        .chart-axis {
            stroke: #dee2e6;
            stroke-width: 1;
        }
        
        .pie-slice {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        .pie-slice:hover {
            transform: scale(1.05);
            transform-origin: center;
        }
    </style>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa; 
        }
        
        .header { 
            text-align: center; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            margin-bottom: 30px; 
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 { 
            margin: 0; 
            font-size: 2.5em; 
            font-weight: 300; 
        }
        
        .header p { 
            margin: 10px 0 0 0; 
            opacity: 0.9; 
        }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
        }
        
        .stat { 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            transition: transform 0.2s ease;
        }
        
        .stat:hover { 
            transform: translateY(-2px); 
        }
        
        .stat .number { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 10px;
        }
        
        .stat .label { 
            color: #6c757d; 
            font-size: 14px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filters-container { 
            background: white; 
            padding: 30px; 
            margin-bottom: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
        }
        
        .filters-title { 
            font-size: 22px; 
            font-weight: 600; 
            color: #495057; 
            margin-bottom: 25px; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filters-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px;
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .filter-label { 
            font-weight: 600; 
            color: #495057; 
            font-size: 14px; 
        }
        
        .filter-control { 
            padding: 12px 16px; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            font-size: 14px; 
            background: white;
            transition: border-color 0.2s ease;
        }
        
        .filter-control:focus { 
            border-color: #667eea; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        
        .btn-secondary:hover { 
            background: #5a6268; 
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            height: 800px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px;
        }
        
        .chart-card {
            position: relative;
            background: white;
            border: none;
            overflow: hidden;
        }
        
        .chart-title {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: 600;
            color: #2a3f5f;
            margin: 0;
            padding: 5px 0;
            z-index: 10;
        }
        
        .chart-content {
            padding-top: 30px;
            height: 100%;
            position: relative;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Dashboard de An√°lise de Incidentes</h1>
        <p>Sistema Interativo de Monitoramento e An√°lise</p>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="number" id="totalRegistros">-</div>
            <div class="label">Total de Registros</div>
        </div>
        <div class="stat">
            <div class="number" id="totalIncidentes">-</div>
            <div class="label">Total de Incidentes</div>
        </div>
        <div class="stat">
            <div class="number" id="totalLocais">-</div>
            <div class="label">Locais Ativos</div>
        </div>
        <div class="stat">
            <div class="number" id="periodo">-</div>
            <div class="label">Per√≠odo</div>
        </div>
    </div>

    <div class="filters-container">
        <div class="filters-title">
            üéõÔ∏è Filtros Interativos
        </div>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">Categoria:</label>
                <select id="categoriaFilter" class="filter-control" multiple>
                    <option value="">Todas as Categorias</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Local:</label>
                <select id="localFilter" class="filter-control" multiple>
                    <option value="">Todos os Locais</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Severidade:</label>
                <select id="severidadeFilter" class="filter-control" multiple>
                    <option value="">Todas as Severidades</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Ano:</label>
                <select id="anoFilter" class="filter-control" multiple>
                    <option value="">Todos os Anos</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Causa:</label>
                <select id="causaFilter" class="filter-control" multiple>
                    <option value="">Todas as Causas</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Status:</label>
                <select id="statusFilter" class="filter-control" multiple>
                    <option value="">Todos os Status</option>
                </select>
            </div>
        </div>
        
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="aplicarFiltros()">
                üîÑ Aplicar Filtros
            </button>
            <button class="btn btn-secondary" onclick="resetarFiltros()">
                ‚Üª Resetar Todos
            </button>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-card">
            <h3 class="chart-title">üìä Incidentes por Categoria</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartCategory">
                    <svg class="chart-svg" id="chartCategorySvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">üîç Incidentes por Causa</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartCause">
                    <svg class="chart-svg" id="chartCauseSvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">üìà Tend√™ncia Temporal</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartTrend">
                    <svg class="chart-svg" id="chartTrendSvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">üè¢ Incidentes por Local</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartSite">
                    <svg class="chart-svg" id="chartSiteSvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">üìÖ Distribui√ß√£o Mensal</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartMonth">
                    <svg class="chart-svg" id="chartMonthSvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">‚ö†Ô∏è Severidade</h3>
            <div class="chart-content">
                <div class="chart-container" id="chartSeverity">
                    <svg class="chart-svg" id="chartSeveritySvg">
                        <text x="50%" y="50%" text-anchor="middle" class="chart-text">Carregando gr√°fico...</text>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardData = [];
        let filteredData = [];

        // Load data and initialize dashboard
        async function loadData() {
            try {
                const response = await fetch('dashboard_data.json');
                dashboardData = await response.json();
                filteredData = [...dashboardData];
                
                initializeFilters();
                updateDashboard();
                showNotification('Dashboard carregado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                // Fallback data for demo
                generateSampleData();
                initializeFilters();
                updateDashboard();
                showNotification('Dashboard inicializado com dados de demonstra√ß√£o', 'warning');
            }
        }

        // Generate sample data if JSON file is not available
        function generateSampleData() {
            const categories = ['Customer', 'Spill', 'Injury', 'Transport', 'Equipment', 'Security', 'Divergence', 'Complaint'];
            const causes = ['Material', 'Procedure', 'Design', 'Training', 'Management', 'External', 'Equipment', 'Personnel'];
            const sites = ['Weston', 'Bolton', 'Shirley', 'Lincoln', 'Maynard', 'Acton', 'Concord', 'Hudson'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const years = [2007, 2008, 2009];
            const severities = ['Critical', 'Major', 'Medium', 'Near Miss'];
            const statuses = ['Open', 'Closed'];
            
            dashboardData = [];
            
            for (let year of years) {
                for (let month of months) {
                    for (let site of sites) {
                        for (let category of categories) {
                            for (let i = 0; i < 2; i++) {
                                const cause = causes[Math.floor(Math.random() * causes.length)];
                                const severity = severities[Math.floor(Math.random() * severities.length)];
                                const status = statuses[Math.floor(Math.random() * statuses.length)];
                                const count = Math.floor(Math.random() * 15) + 1;
                                
                                dashboardData.push({
                                    Category: category,
                                    Cause: cause,
                                    Site: site,
                                    Month: month,
                                    Year: year,
                                    Severity: severity,
                                    Status: status,
                                    Count: count
                                });
                            }
                        }
                    }
                }
            }
            
            filteredData = [...dashboardData];
        }

        // Initialize filter dropdowns
        function initializeFilters() {
            const filters = {
                categoriaFilter: 'Category',
                localFilter: 'Site',
                severidadeFilter: 'Severity',
                anoFilter: 'Year',
                causaFilter: 'Cause',
                statusFilter: 'Status'
            };

            Object.entries(filters).forEach(([filterId, field]) => {
                const select = document.getElementById(filterId);
                const uniqueValues = [...new Set(dashboardData.map(item => item[field]))].sort();
                
                // Clear existing options except the first one
                select.innerHTML = select.innerHTML.split('\n')[0];
                
                uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            });
        }

        // Apply filters to data
        function aplicarFiltros() {
            const filters = {
                Category: getSelectedValues('categoriaFilter'),
                Site: getSelectedValues('localFilter'),
                Severity: getSelectedValues('severidadeFilter'),
                Year: getSelectedValues('anoFilter').map(Number),
                Cause: getSelectedValues('causaFilter'),
                Status: getSelectedValues('statusFilter')
            };

            filteredData = dashboardData.filter(item => {
                return Object.entries(filters).every(([field, values]) => {
                    return values.length === 0 || values.includes(item[field]);
                });
            });

            updateDashboard();
            updateDashboard();
            showNotification(`Filtros aplicados! ${filteredData.length} registros encontrados.`);
        }

        // Reset all filters
        function resetarFiltros() {
            const filterIds = ['categoriaFilter', 'localFilter', 'severidadeFilter', 'anoFilter', 'causaFilter', 'statusFilter'];
            filterIds.forEach(id => {
                const select = document.getElementById(id);
                Array.from(select.options).forEach(option => option.selected = false);
            });

            filteredData = [...dashboardData];
            updateDashboard();
            showNotification('Filtros resetados!');
        }

        // Get selected values from multi-select
        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== '');
        }

        // Update all dashboard components
        function updateDashboard() {
            updateStatistics();
            updateCharts();
        }

        // Update all charts
        function updateCharts() {
            updateCategoryChart();
            updateCauseChart();
            updateTrendChart();
            updateSiteChart();
            updateMonthChart();
            updateSeverityChart();
        }

        // Create bar chart using SVG with improved styling
        function createBarChart(svgId, data, colors = '#636efa') {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            svg.innerHTML = '';
            
            const width = 300;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 70, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const maxValue = Math.max(...data.map(d => d.value));
            const barWidth = chartWidth / data.length;

            // Chart group
            const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            chartGroup.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);

            // Background grid lines
            for (let i = 0; i <= 5; i++) {
                const y = (chartHeight / 5) * i;
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', '0');
                gridLine.setAttribute('y1', y);
                gridLine.setAttribute('x2', chartWidth);
                gridLine.setAttribute('y2', y);
                gridLine.setAttribute('stroke', '#E5ECF6');
                gridLine.setAttribute('stroke-width', '1');
                chartGroup.appendChild(gridLine);

                // Y-axis labels
                const value = Math.round((maxValue * (5 - i)) / 5);
                const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                yLabel.setAttribute('x', '-10');
                yLabel.setAttribute('y', y + 4);
                yLabel.setAttribute('text-anchor', 'end');
                yLabel.setAttribute('class', 'chart-text');
                yLabel.setAttribute('font-size', '11');
                yLabel.setAttribute('fill', '#2a3f5f');
                yLabel.textContent = value.toLocaleString();
                chartGroup.appendChild(yLabel);
            }

            // Bars and labels
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = index * barWidth + barWidth * 0.15;
                const y = chartHeight - barHeight;

                // Bar
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', x);
                bar.setAttribute('y', y);
                bar.setAttribute('width', barWidth * 0.7);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('fill', colors);
                bar.setAttribute('class', 'chart-bar');
                bar.setAttribute('title', `${item.label}: ${item.value}`);
                bar.style.cursor = 'pointer';
                chartGroup.appendChild(bar);

                // Value label on top of bar
                const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueLabel.setAttribute('x', x + (barWidth * 0.35));
                valueLabel.setAttribute('y', y - 5);
                valueLabel.setAttribute('text-anchor', 'middle');
                valueLabel.setAttribute('class', 'chart-text');
                valueLabel.setAttribute('font-size', '11');
                valueLabel.setAttribute('fill', '#2a3f5f');
                valueLabel.textContent = item.value.toLocaleString();
                chartGroup.appendChild(valueLabel);

                // X-axis labels
                const labelText = item.label.length > 8 ? item.label.substring(0, 8) + '...' : item.label;
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', x + (barWidth * 0.35));
                label.setAttribute('y', chartHeight + 20);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('class', 'chart-text');
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', '#2a3f5f');
                label.textContent = labelText;
                chartGroup.appendChild(label);
            });

            svg.appendChild(chartGroup);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        }

        // Create horizontal bar chart for locations
        function createHorizontalBarChart(svgId, data, colors = '#ab63fa') {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            svg.innerHTML = '';
            
            const width = 300;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 20, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const maxValue = Math.max(...data.map(d => d.value));
            const barHeight = chartHeight / data.length;

            // Chart group
            const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            chartGroup.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);

            // Background grid lines
            for (let i = 0; i <= 5; i++) {
                const x = (chartWidth / 5) * i;
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', x);
                gridLine.setAttribute('y1', '0');
                gridLine.setAttribute('x2', x);
                gridLine.setAttribute('y2', chartHeight);
                gridLine.setAttribute('stroke', '#E5ECF6');
                gridLine.setAttribute('stroke-width', '1');
                chartGroup.appendChild(gridLine);
            }

            // Bars and labels
            data.forEach((item, index) => {
                const barWidth = (item.value / maxValue) * chartWidth;
                const x = 0;
                const y = index * barHeight + barHeight * 0.15;

                // Bar
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', x);
                bar.setAttribute('y', y);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight * 0.7);
                bar.setAttribute('fill', colors);
                bar.setAttribute('class', 'chart-bar');
                bar.setAttribute('title', `${item.label}: ${item.value}`);
                chartGroup.appendChild(bar);

                // Value label at end of bar
                const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueLabel.setAttribute('x', barWidth + 5);
                valueLabel.setAttribute('y', y + (barHeight * 0.45));
                valueLabel.setAttribute('text-anchor', 'start');
                valueLabel.setAttribute('class', 'chart-text');
                valueLabel.setAttribute('font-size', '11');
                valueLabel.setAttribute('fill', '#2a3f5f');
                valueLabel.textContent = item.value.toLocaleString();
                chartGroup.appendChild(valueLabel);

                // Y-axis labels
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', '-10');
                label.setAttribute('y', y + (barHeight * 0.45));
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('class', 'chart-text');
                label.setAttribute('font-size', '10');
                label.setAttribute('fill', '#2a3f5f');
                label.textContent = item.label;
                chartGroup.appendChild(label);
            });

            svg.appendChild(chartGroup);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        }

        // Create line chart for temporal trends
        function createLineChart(svgId, data, colors = '#EF553B') {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            svg.innerHTML = '';
            
            const width = 300;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 70, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            if (data.length === 0) return;

            const maxValue = Math.max(...data.map(d => d.value));
            const minValue = Math.min(...data.map(d => d.value));
            const xStep = chartWidth / (data.length - 1);

            // Chart group
            const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            chartGroup.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);

            // Background grid lines
            for (let i = 0; i <= 5; i++) {
                const y = (chartHeight / 5) * i;
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', '0');
                gridLine.setAttribute('y1', y);
                gridLine.setAttribute('x2', chartWidth);
                gridLine.setAttribute('y2', y);
                gridLine.setAttribute('stroke', '#E5ECF6');
                gridLine.setAttribute('stroke-width', '1');
                chartGroup.appendChild(gridLine);
            }

            // Create path for line
            const pathData = data.map((item, index) => {
                const x = index * xStep;
                const y = chartHeight - ((item.value - minValue) / (maxValue - minValue)) * chartHeight;
                return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', colors);
            path.setAttribute('stroke-width', '2');
            chartGroup.appendChild(path);

            // Add points
            data.forEach((item, index) => {
                const x = index * xStep;
                const y = chartHeight - ((item.value - minValue) / (maxValue - minValue)) * chartHeight;

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '3');
                circle.setAttribute('fill', colors);
                circle.setAttribute('title', `${item.label}: ${item.value}`);
                chartGroup.appendChild(circle);

                // X-axis labels
                if (index % Math.ceil(data.length / 6) === 0) {
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', chartHeight + 20);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('class', 'chart-text');
                    label.setAttribute('font-size', '9');
                    label.setAttribute('fill', '#2a3f5f');
                    label.textContent = item.label.substring(0, 6);
                    chartGroup.appendChild(label);
                }
            });

            svg.appendChild(chartGroup);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        }

        // Create pie chart using SVG with improved styling
        function createPieChart(svgId, data) {
            const svg = document.getElementById(svgId);
            if (!svg) return;

            svg.innerHTML = '';
            
            const width = 300;
            const height = 300;
            const centerX = width / 2;
            const centerY = height / 2 - 20;
            const radius = Math.min(width, height) / 3;

            const total = data.reduce((sum, item) => sum + item.value, 0);
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];

            let currentAngle = -Math.PI / 2; // Start from top

            data.forEach((item, index) => {
                const percentage = item.value / total;
                const angle = percentage * 2 * Math.PI;
                const endAngle = currentAngle + angle;

                // Create path for pie slice
                const largeArcFlag = angle > Math.PI ? 1 : 0;
                const x1 = centerX + radius * Math.cos(currentAngle);
                const y1 = centerY + radius * Math.sin(currentAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const pathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', colors[index % colors.length]);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('class', 'pie-slice');
                path.setAttribute('title', `${item.label}: ${item.value} (${(percentage * 100).toFixed(1)}%)`);
                svg.appendChild(path);

                // Add percentage label
                const labelAngle = currentAngle + angle / 2;
                const labelRadius = radius * 0.7;
                const labelX = centerX + labelRadius * Math.cos(labelAngle);
                const labelY = centerY + labelRadius * Math.sin(labelAngle);

                if (percentage > 0.05) { // Only show label if slice is big enough
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', labelX);
                    label.setAttribute('y', labelY);
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('class', 'chart-text');
                    label.setAttribute('fill', 'white');
                    label.setAttribute('font-weight', 'bold');
                    label.setAttribute('font-size', '12');
                    label.textContent = `${(percentage * 100).toFixed(1)}%`;
                    svg.appendChild(label);
                }

                currentAngle = endAngle;
            });

            // Add legend at the bottom
            const legendStartY = height - 80;
            const legendItemWidth = width / Math.min(data.length, 4);
            
            data.forEach((item, index) => {
                const row = Math.floor(index / 4);
                const col = index % 4;
                const legendX = col * legendItemWidth + 10;
                const legendY = legendStartY + row * 20;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', legendX);
                rect.setAttribute('y', legendY);
                rect.setAttribute('width', '12');
                rect.setAttribute('height', '12');
                rect.setAttribute('fill', colors[index % colors.length]);
                svg.appendChild(rect);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', legendX + 16);
                text.setAttribute('y', legendY + 9);
                text.setAttribute('class', 'chart-text');
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', '#2a3f5f');
                text.textContent = item.label.length > 8 ? item.label.substring(0, 8) + '...' : item.label;
                svg.appendChild(text);
            });

            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        }

        // Update category chart
        function updateCategoryChart() {
            const categoryData = groupBy(filteredData, 'Category', 'Count');
            const sortedData = Object.entries(categoryData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([label, value]) => ({ label, value }));
            
            createBarChart('chartCategorySvg', sortedData, '#636efa');
        }

        // Update cause chart
        function updateCauseChart() {
            const causeData = groupBy(filteredData, 'Cause', 'Count');
            const sortedData = Object.entries(causeData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([label, value]) => ({ label, value }));
            
            createBarChart('chartCauseSvg', sortedData, '#00cc96');
        }

        // Update trend chart (line chart for temporal trends)
        function updateTrendChart() {
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const trendData = {};
            
            filteredData.forEach(item => {
                const key = `${item.Year}-${item.Month}`;
                trendData[key] = (trendData[key] || 0) + item.Count;
            });

            const sortedTrends = Object.entries(trendData)
                .sort((a, b) => {
                    const [yearA, monthA] = a[0].split('-');
                    const [yearB, monthB] = b[0].split('-');
                    const dateA = new Date(yearA, monthOrder.indexOf(monthA));
                    const dateB = new Date(yearB, monthOrder.indexOf(monthB));
                    return dateA - dateB;
                })
                .slice(0, 12)
                .map(([label, value]) => ({ label, value }));

            createLineChart('chartTrendSvg', sortedTrends, '#EF553B');
        }

        // Update site chart (horizontal bars)
        function updateSiteChart() {
            const siteData = groupBy(filteredData, 'Site', 'Count');
            const sortedData = Object.entries(siteData)
                .sort((a, b) => b[1] - a[1])
                .map(([label, value]) => ({ label, value }));
            
            createHorizontalBarChart('chartSiteSvg', sortedData, '#ab63fa');
        }

        // Update month chart
        function updateMonthChart() {
            const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthData = groupBy(filteredData, 'Month', 'Count');
            
            const sortedData = monthOrder.map(month => ({
                label: month,
                value: monthData[month] || 0
            }));
            
            createBarChart('chartMonthSvg', sortedData, '#00cc96');
        }

        // Update severity chart
        function updateSeverityChart() {
            const severityData = groupBy(filteredData, 'Severity', 'Count');
            const sortedData = Object.entries(severityData)
                .map(([label, value]) => ({ label, value }));
            
            createPieChart('chartSeveritySvg', sortedData);
        }

        // Update statistics cards
        function updateStatistics() {
            const totalRecords = filteredData.length;
            const totalIncidents = filteredData.reduce((sum, item) => sum + item.Count, 0);
            const activeSites = new Set(filteredData.map(item => item.Site)).size;
            const years = [...new Set(filteredData.map(item => item.Year))].sort();
            const period = years.length > 0 ? `${Math.min(...years)} - ${Math.max(...years)}` : 'N/A';

            document.getElementById('totalRegistros').textContent = totalRecords.toLocaleString();
            document.getElementById('totalIncidentes').textContent = totalIncidents.toLocaleString();
            document.getElementById('totalLocais').textContent = activeSites;
            document.getElementById('periodo').textContent = period;
        }

        // Helper function to group data
        function groupBy(data, field, valueField) {
            const result = {};
            data.forEach(item => {
                const key = item[field];
                result[key] = (result[key] || 0) + item[valueField];
            });
            return result;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'warning') {
                notification.style.background = '#ed8936';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>